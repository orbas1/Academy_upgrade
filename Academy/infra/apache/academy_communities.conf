# Academy Communities Production VirtualHost (Apache HTTPD 2.4)
# Hardened configuration with CDN/WAF integration mirroring the Nginx edge posture.

<IfModule !mod_ssl.c>
    LoadModule ssl_module modules/mod_ssl.so
</IfModule>
<IfModule !mod_http2.c>
    LoadModule http2_module modules/mod_http2.so
</IfModule>
<IfModule !mod_proxy.c>
    LoadModule proxy_module modules/mod_proxy.so
</IfModule>
<IfModule !mod_proxy_fcgi.c>
    LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
</IfModule>
<IfModule !mod_proxy_wstunnel.c>
    LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
</IfModule>
<IfModule !mod_remoteip.c>
    LoadModule remoteip_module modules/mod_remoteip.so
</IfModule>
<IfModule !mod_security2.c>
    LoadModule security2_module modules/mod_security2.so
</IfModule>
<IfModule !mod_headers.c>
    LoadModule headers_module modules/mod_headers.so
</IfModule>
<IfModule !mod_rewrite.c>
    LoadModule rewrite_module modules/mod_rewrite.so
</IfModule>
<IfModule !mod_deflate.c>
    LoadModule deflate_module modules/mod_deflate.so
</IfModule>

<VirtualHost *:443>
    ServerName communities.academy.example
    ServerAdmin ops@academy.example

    Protocols h2 http/1.1
    SSLEngine on
    SSLCertificateFile      /etc/letsencrypt/live/communities.academy.example/fullchain.pem
    SSLCertificateKeyFile   /etc/letsencrypt/live/communities.academy.example/privkey.pem
    SSLProtocol             +TLSv1.2 +TLSv1.3
    SSLCipherSuite          TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
    SSLHonorCipherOrder     on
    SSLCompression          off
    SSLUseStapling          on
    SSLStaplingCache        "shmcb:/var/run/ocsp(128000)"

    DocumentRoot /var/www/academy/current/public

    # Real client IP extraction from CDN/edge POPs.
    RemoteIPHeader X-Forwarded-For
    RemoteIPInternalProxy 10.0.0.0/16
    RemoteIPInternalProxy 192.168.0.0/16
    RemoteIPTrustedProxy 13.32.0.0/15
    RemoteIPTrustedProxy 52.46.0.0/18

    # Logging aligned with JSON format for ingestion pipelines.
    LogFormat '{"time":"%{%Y-%m-%dT%H:%M:%S%z}t","remote_ip":"%a","user":"%u","host":"%V","method":"%m","path":"%U","query":"%q","protocol":"%H","status":%>s,"bytes":%B,"referer":"%{Referer}i","agent":"%{User-Agent}i","request_id":"%{UNIQUE_ID}e"}' json_combined
    CustomLog "/var/log/apache2/communities.access.log" json_combined
    ErrorLog  "/var/log/apache2/communities.error.log"

    # Attach a unique request id propagated to upstream services.
    RewriteEngine on
    RewriteCond %{ENV:UNIQUE_ID} ="
    RewriteRule .* - [E=UNIQUE_ID:%{TIME_US}-%{REMOTE_ADDR}]
    RequestHeader set X-Request-Id "%{UNIQUE_ID}e"

    # Hardened headers (mirrors Laravel + edge defaults).
    IncludeOptional conf/security-headers.conf

    # Web application firewall (ModSecurity v3 with OWASP CRS tuning).
    SecRuleEngine On
    Include "/etc/modsecurity/owasp-crs/load.conf"
    IncludeOptional "/etc/modsecurity/academy/overrides.conf"

    # Drop unsupported HTTP verbs early.
    <Location />
        <LimitExcept GET POST PUT PATCH DELETE OPTIONS>
            Require all denied
        </LimitExcept>
    </Location>

    # Timeouts & DoS guardrails.
    RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=1024

    # Static asset caching (Apache handles gzip/brotli via deflate/brotli modules).
    <LocationMatch "^/assets/.+\.(?:css|js|woff2?|ttf|eot|png|jpe?g|gif|ico|svg|webp|avif)$">
        Header set Cache-Control "public, max-age=2592000, immutable"
        ExpiresActive On
        ExpiresDefault "access plus 30 days"
    </LocationMatch>

    # Media proxy to S3+CloudFront shield.
    ProxyPass        /storage/ https://media-cdn.academy.example/storage/ ttl=60 keepalive=On retry=0
    ProxyPassReverse /storage/ https://media-cdn.academy.example/storage/
    Header always set Cache-Control "public, max-age=43200, s-maxage=86400" "expr=%{REQUEST_URI} =~ m#^/storage/#"

    # API throttling helpers (requires mod_evasive + mod_ratelimit global config).
    <Location /api/>
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 32768
        Header always set X-Accel-Buffering "no"
    </Location>

    # WebSocket fan-out.
    ProxyPass        /ws/ ws://127.0.0.1:6001/
    ProxyPassReverse /ws/ ws://127.0.0.1:6001/

    # Pass PHP scripts to PHP-FPM over unix socket.
    <FilesMatch "\.php$">
        SetHandler "proxy:unix:/run/php/php8.3-fpm.sock|fcgi://localhost/var/www/academy/current/public"
    </FilesMatch>

    <Directory /var/www/academy/current/public>
        Options FollowSymLinks
        AllowOverride None
        Require all granted

        # Protect dotfiles and composer artifacts.
        RedirectMatch 404 /\.(?!well-known)

        # Front controller routing for Laravel (replaces .htaccess).
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ index.php [L]
    </Directory>

    # Health check endpoint for load balancers.
    <Location "/_status">
        SetHandler None
        Require all granted
        Header set Content-Type application/json
        SetEnvIf Expr "true" dontlog
    </Location>

    # Upstream forwarding defaults.
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto https
    RequestHeader set X-Forwarded-Host "%{HOSTNAME}s"
</VirtualHost>

<VirtualHost *:80>
    ServerName communities.academy.example
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [L,R=301]
</VirtualHost>

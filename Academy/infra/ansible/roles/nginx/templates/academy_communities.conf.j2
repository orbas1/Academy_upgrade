# Academy Communities Production Virtual Host (managed by Ansible)

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

limit_req_zone $binary_remote_addr zone=api_throttle:10m rate=25r/s;
limit_conn_zone $binary_remote_addr zone=per_ip:10m;

upstream backend_app {
{% if nginx_upstream_servers | length > 0 %}
{%   for server in nginx_upstream_servers %}
    server {{ server }};
{%   endfor %}
{% else %}
    server unix:{{ nginx_upstream_socket }};
{% endif %}
    keepalive 16;
}

upstream websocket_backend {
    server {{ nginx_websocket_host }}:{{ nginx_websocket_port }};
    keepalive 16;
}

server {
    listen 443 ssl http2;
    server_name {{ nginx_domain }};

    ssl_certificate     {{ nginx_tls_cert_path }};
    ssl_certificate_key {{ nginx_tls_key_path }};
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256';
    ssl_session_cache   shared:SSL:50m;
    ssl_session_timeout 1d;
    ssl_stapling        on;
    ssl_stapling_verify on;

{% for cidr in nginx_real_ip_ranges %}
    set_real_ip_from {{ cidr }};
{% endfor %}
    real_ip_header X-Forwarded-For;

    access_log {{ nginx_access_log }} json_combined;
    error_log  {{ nginx_error_log }}  warn;

    include snippets/security-headers.conf;

    modsecurity on;
    modsecurity_rules_file /etc/nginx/modsecurity/main.conf;

    if ($request_method !~ ^(GET|POST|PUT|PATCH|DELETE|OPTIONS)$) {
        return 405;
    }

    location = /_status {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"ok"}';
    }

    location ~* \.(?:css|js|woff2?|ttf|eot|png|jpe?g|gif|ico|svg|webp|avif)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
        try_files $uri $uri/ /index.php?$query_string;
    }

    location /storage/ {
        expires 12h;
        add_header Cache-Control "public, max-age=43200, s-maxage=86400";
        proxy_pass https://media-cdn.{{ nginx_domain }}$request_uri;
        proxy_set_header Host media-cdn.{{ nginx_domain }};
        proxy_set_header X-Forwarded-Proto https;
        proxy_hide_header x-amz-id-2;
        proxy_hide_header x-amz-request-id;
    }

    location /api/ {
        limit_req zone=api_throttle burst=30 nodelay;
        limit_conn per_ip 30;
        proxy_pass http://backend_app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Request-Id $request_id;
        proxy_set_header Connection "";
        proxy_read_timeout 60s;
    }

    location /broadcasting/auth {
        proxy_pass http://backend_app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Request-Id $request_id;
    }

    location /ws/ {
        proxy_pass http://websocket_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 60s;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass backend_app;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param APP_ENV production;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        fastcgi_read_timeout 120s;
    }

    location ~ /\.(?!well-known) {
        deny all;
    }
}

server {
    listen 80;
    server_name {{ nginx_domain }};
    return 301 https://$host$request_uri;
}
